<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>דוח סיכום תלמיד</title>
    <!-- Add Noto Sans Hebrew from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
    <!-- Add Firebase SDKs after existing scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        body {
            font-family: 'Noto Sans Hebrew', sans-serif;
            font-size: 0.85rem;
            background-color: #f8f9fa;
        }
        .rtl {
            direction: rtl;
            text-align: right;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 20px;
            font-size: 0.8rem;
            line-height: 1.7;
        }
        th, td {
            padding: 6px 10px;
            text-align: right;
            border: none;
        }
        th {
            font-weight: 700;
            position: relative;
            text-align: center;
            border-bottom: 2px solid #dee2e6;
            background-color: transparent;
            color: #333;
            padding-bottom: 8px;
        }
        /* Remove borders and add zebra striping */
        .table-borderless tbody tr:nth-child(odd) {
            background-color: rgba(0, 0, 0, 0.03);
        }
        .table-borderless tbody tr:nth-child(even) {
            background-color: #fff;
        }
        .table-borderless td, .table-borderless th {
            border: none;
        }
        .table-borderless tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.05);
        }
        .report-container {
            max-width: 700px;
            margin: 0 auto;
            padding: 25px;
            background-color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        .controls {
            margin-bottom: 15px;
        }
        .report-title {
            text-align: center;
            margin-bottom: 25px;
            font-weight: 700;
            font-size: 1.5rem;
            padding-bottom: 15px;
            border-bottom: 2px solid #eaeaea;
        }
        .comments-section {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 2px solid #eaeaea;
        }
        .check-mark {
            text-align: center;
            color: #45c1a4;
            font-size: 0.9rem;
            line-height: 1;
        }
        /* Add style to ensure consistent checkmark appearance */
        .check-mark i {
            /* Create a small white background circle behind the checkmark */
            background-color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            /* Ensure the icon sits on top */
            position: relative;
            z-index: 2;
            /* Remove any transparency */
            opacity: 1;
        }
        .check-column {
            width: 22%;
            text-align: center;
        }
        .subject-column {
            width: 28%;
        }
        .category-column {
            width: 28%;
        }
        @media print {
            .no-print {
                display: none !important;
            }
            .report-container {
                padding: 0;
                max-width: 100%;
                box-shadow: none;
            }
            body {
                background-color: white;
                font-size: 0.8rem;
            }
            .table-borderless tbody tr:nth-child(odd) {
                background-color: rgba(0, 0, 0, 0.03) !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            th {
                font-weight: 700 !important;
                color: #333 !important;
                border-bottom: 2px solid #dee2e6 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            /* Ensure checkmarks print with consistent color */
            .check-mark i {
                color: #45c1a4 !important;
                background-color: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
        .loading-indicator {
            text-align: center;
            margin: 15px;
            display: none;
        }
        .student-report {
            display: none;
        }
        
        /* Make buttons smaller */
        .btn {
            font-size: 0.8rem;
            padding: 0.25rem 0.75rem;
        }
        
        /* Space out buttons */
        .button-group {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        /* Make dropdowns and inputs smaller */
        .form-select, .form-control {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        
        /* Fix RTL dropdown arrow overlap - stronger approach */
        .form-select {
            padding-left: 2.5rem !important;  /* Force extra padding on the left side */
            padding-right: 1rem !important;   /* Add padding on right side too */
            text-align: right !important;     /* Force right alignment */
        }
        
        /* Add a custom style to the student select specifically */
        #studentSelect {
            direction: rtl;
            position: relative;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap
        }
        
        .form-label {
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }
        
        .card-header h3 {
            font-size: 1.3rem;
            margin-bottom: 0;
        }
        
        .card {
            border-radius: 0.25rem;
            margin-bottom: 0.75rem;
            border: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* Make headers in table smaller */
        .table thead th {
            font-size: 0.9rem;
            padding: 0.75rem;
        }
        
        /* Style for comments section */
        .comments-section h5 {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 12px;
            color: #3873b6;
        }
        
        .section-label {
            display: inline-block;
            background-color: #f1f7ff;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 500;
            margin-bottom: 6px;
        }
        
        /* Override Bootstrap's select styling for RTL */
        .rtl-select-wrapper {
            position: relative;
            width: 100%;
        }
        
        .rtl-select-wrapper select {
            width: 100%;
            padding-right: 1rem;
            padding-left: 2.5rem; /* More space for the arrow */
            appearance: none;  /* Remove default appearance */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-color: #fff;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            font-size: 0.8rem;
            height: calc(1.5em + 0.5rem + 2px);
            text-align: right;
            direction: rtl;
        }
        
        /* Custom dropdown arrow */
        .rtl-select-wrapper::after {
            content: '';
            position: absolute;
            left: 10px;  /* Position from left (appears at right in RTL) */
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid #343a40;
            pointer-events: none;  /* Make sure it doesn't interfere with clicking */
        }
        
        /* Make the standard form-select have no default arrow in our custom wrapper */
        .rtl-select-wrapper .form-select {
            background-image: none;
        }
        
        /* Override Bootstrap's primary color */
        .btn-primary, .bg-primary {
            background-color: #329da6 !important;
            border-color: #329da6 !important;
        }
        
        /* Override Bootstrap's secondary color */
        .btn-secondary {
            background-color: #6c757d !important;
            border-color: #6c757d !important;
        }
        
        /* State Management Sidebar */
        .sidebar {
            position: fixed;
            right: 0;
            top: 0;
            height: 100%;
            width: 250px;
            background-color: #f8f9fa;
            border-left: 1px solid #e3e3e3;
            padding: 15px;
            overflow-y: auto;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .sidebar.open {
            transform: translateX(0);
        }
        
        .sidebar-toggle {
            position: fixed;
            right: 20px;
            bottom: 20px;
            z-index: 1001;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #329da6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .state-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .state-item {
            padding: 10px;
            border-bottom: 1px solid #e3e3e3;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .state-item:hover {
            background-color: #f0f0f0;
        }
        
        .state-item.active {
            background-color: #e6f7f8;
            border-right: 3px solid #329da6;
        }
        
        .state-tools {
            display: flex;
            gap: 5px;
        }
        
        .state-name {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #e3e3e3;
            padding-bottom: 10px;
        }
        
        .state-input-container {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .state-input {
            flex-grow: 1;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
            }
        }
        
        .main-content {
            transition: margin-right 0.3s ease;
        }
        
        .main-content.sidebar-open {
            margin-right: 250px;
        }
        
        /* Add styles for the new elements */
        .state-actions {
            margin-top: 10px;
            margin-bottom: 15px;
        }
        
        .state-list-header {
            margin-top: 10px;
            margin-bottom: 10px;
            padding-top: 10px;
            border-top: 1px solid #e3e3e3;
        }
    </style>
</head>
<body>
    <div class="sidebar" id="stateSidebar">
        <div class="sidebar-header">
            <h5>משימות הערכה שמורות</h5>
            <button class="btn btn-sm btn-outline-secondary close-sidebar">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- State name input -->
        <div class="state-input-container">
            <input type="text" class="form-control form-control-sm state-input" id="stateNameInput" placeholder="שם משימת הערכה">
            <button class="btn btn-sm btn-primary" id="saveStateBtn">שמור</button>
        </div>
        
        <!-- Add state management buttons -->
        <div class="state-actions">
            <button class="btn btn-sm btn-outline-primary mb-2 w-100" id="saveAsBtn">
                <i class="fas fa-save"></i> שמור כ...
            </button>
            <button class="btn btn-sm btn-outline-success mb-2 w-100" id="resaveBtn">
                <i class="fas fa-sync-alt"></i> עדכן משימת הערכה נוכחית
            </button>
            <button class="btn btn-sm btn-outline-secondary mb-3 w-100" id="newStateBtn">
                <i class="fas fa-file"></i> משימת הערכה חדשה
            </button>
        </div>
        
        <div class="state-list-header">
            <h6>משימות הערכה קיימות</h6>
        </div>
        <ul class="state-list" id="stateList"></ul>
    </div>
    
    <div class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-save"></i>
    </div>
    
    <div class="container rtl mt-3 main-content" id="mainContent">
        <div class="row no-print">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3>משוב למשימת הערכה</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <label for="fileInput" class="form-label"> בחר קובץ אקסל עם פרטי משימת ההערכה:</label>
                            <input type="file" class="form-control" id="fileInput" accept=".xlsx">
                        </div>
                        <div id="loadingIndicator" class="loading-indicator">
                            <div class="spinner-border text-primary spinner-border-sm" role="status">
                                <span class="visually-hidden">טוען...</span>
                            </div>
                            <p class="mb-0 mt-1">מעבד את קובץ האקסל, אנא המתן...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-3 no-print" id="navigationControls" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <label for="studentSelect" class="form-label">בחר תלמיד:</label>
                                    <div class="rtl-select-wrapper">
                                        <select class="form-select" id="studentSelect"></select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2 d-flex justify-content-end mt-3">
                                    <div class="button-group">
                                        <button id="prevStudent" class="btn btn-secondary">הקודם</button>
                                        <button id="nextStudent" class="btn btn-secondary">הבא</button>
                                        <button id="printReport" class="btn btn-primary">הדפסה</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-2">
                                    <label for="commentsInput" class="form-label">הערות נוספות:</label>
                                    <textarea class="form-control" id="commentsInput" rows="2"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-12">
                <div id="studentReport" class="student-report">
                    <div class="report-container">
                        <h2 id="reportTitle" class="report-title"></h2>
                        <table id="reportTable" class="table table-borderless">
                            <thead>
                                <tr>
                                    <th class="category-column">נושא מתמטי</th>
                                    <th class="subject-column">נושאי השאלות</th>
                                    <th class="check-column">שולט היטב</th>
                                    <th class="check-column">נדרש תרגול נוסף</th>
                                </tr>
                            </thead>
                            <tbody id="reportTableBody">
                                <!-- Will be filled with JavaScript -->
                            </tbody>
                        </table>
                        <div class="comments-section">
                            <h5><span class="section-label">הערות נוספות</span></h5>
                            <p id="reportComments"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBBTAUHqo-KafN5fsM6kDXksMNxeXerWXM",
            authDomain: "evaluation-8d952.firebaseapp.com",
            projectId: "evaluation-8d952",
            storageBucket: "evaluation-8d952.firebasestorage.app",
            messagingSenderId: "526527882681",
            appId: "1:526527882681:web:5b3a8a84b29640da2e4268",
            measurementId: "G-SKWS595N0V"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Get Firebase services
        const firestore = firebase.firestore();
        
        // Initialize IndexedDB for local file storage
        let localDB;
        
        // User identification
        let currentUserId = null;
        let userInitialized = false;
        
        // Generate a unique user ID if not already present
        function getOrCreateUserId() {
            // Try to get existing user ID from localStorage
            let userId = localStorage.getItem('evaluationAppUserId');
            
            if (!userId) {
                // Generate a new user ID - this is a simple UUID-like generator
                userId = 'user_' + Math.random().toString(36).substring(2, 15) + 
                         Math.random().toString(36).substring(2, 15);
                // Save it to localStorage for future use
                localStorage.setItem('evaluationAppUserId', userId);
                console.log('Created new user ID:', userId);
            } else {
                console.log('Using existing user ID:', userId);
            }
            
            return userId;
        }
        
        // Initialize IndexedDB
        async function initIndexedDB() {
            localDB = await idb.openDB('StudentReportsLocalDB', 1, {
                upgrade(db) {
                    // Create a store for file data
                    db.createObjectStore('files', { keyPath: 'id' });
                }
            });
            console.log('IndexedDB initialized for local file storage');
        }
        
        // Initialize the application
        async function initApp() {
            try {
                // Initialize local storage first
                await initIndexedDB();
                
                // Set up user identification
                currentUserId = getOrCreateUserId();
                userInitialized = true;
                
                // After initialization, load states
                loadSavedStates();
            } catch (error) {
                console.error('Error during initialization:', error);
                alert('אירעה שגיאה באתחול: ' + error.message);
            }
        }
        
        // Global variables to store app state
        let studentsData = [];
        let currentStudentIndex = 0;
        let questionsData = {
            broadSubjects: {},
            subjects: {},
            maxScores: {}
        };
        let studentComments = {};
        let currentFileHash = ''; // Used to identify the current Excel file
        let currentStateName = 'משימת הערכה ללא שם'; // Default state name
        let currentStateId = null; // Current state ID
        let currentFileData = null; // Store the current file data

        // DOM elements
        const fileInput = document.getElementById('fileInput');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const navigationControls = document.getElementById('navigationControls');
        const studentSelect = document.getElementById('studentSelect');
        const prevStudentBtn = document.getElementById('prevStudent');
        const nextStudentBtn = document.getElementById('nextStudent');
        const printReportBtn = document.getElementById('printReport');
        const commentsInput = document.getElementById('commentsInput');
        const studentReport = document.getElementById('studentReport');
        const reportTitle = document.getElementById('reportTitle');
        const reportTableBody = document.getElementById('reportTableBody');
        const reportComments = document.getElementById('reportComments');
        
        // State management elements
        const sidebarToggle = document.getElementById('sidebarToggle');
        const stateSidebar = document.getElementById('stateSidebar');
        const closeSidebarBtn = document.querySelector('.close-sidebar');
        const stateList = document.getElementById('stateList');
        const stateNameInput = document.getElementById('stateNameInput');
        const saveStateBtn = document.getElementById('saveStateBtn');
        const saveAsBtn = document.getElementById('saveAsBtn');
        const resaveBtn = document.getElementById('resaveBtn');
        const newStateBtn = document.getElementById('newStateBtn');
        const mainContent = document.getElementById('mainContent');
        
        // Initialize app when the page loads
        document.addEventListener('DOMContentLoaded', initApp);
        
        // Save current state - hybrid approach (Firestore + IndexedDB)
        async function saveCurrentState() {
            if (!currentFileData) {
                alert('אנא טען קובץ תחילה');
                return;
            }
            
            if (!userInitialized) {
                alert('אנא המתן לאתחול המערכת...');
                return;
            }
            
            // Show loading indicator
            loadingIndicator.style.display = 'block';
            
            const stateName = stateNameInput.value.trim() || currentStateName;
            
            try {
                // Create a simplified version of the data for storage
                const simplifiedStudentsData = studentsData.map(student => ({
                    name: student.name,
                    totalScore: student.totalScore,
                    scores: {...student.scores}
                }));
                
                // Simplify the questions data
                const simplifiedQuestionsData = {
                    broadSubjects: {...questionsData.broadSubjects},
                    subjects: {...questionsData.subjects},
                    maxScores: {...questionsData.maxScores}
                };
                
                // Add the other data items (simplified)
                Object.keys(questionsData).forEach(key => {
                    if (key !== 'broadSubjects' && key !== 'subjects' && key !== 'maxScores') {
                        simplifiedQuestionsData[key] = {};
                        
                        // Copy the nested structure while avoiding circular references
                        Object.keys(questionsData[key] || {}).forEach(subKey => {
                            simplifiedQuestionsData[key][subKey] = [...(questionsData[key][subKey] || [])];
                        });
                    }
                });
                
                // Save file data locally in IndexedDB
                await localDB.put('files', {
                    id: currentFileHash,
                    data: currentFileData,
                    timestamp: new Date().getTime()
                });
                
                // Create the state document for Firestore (without file data)
                const stateData = {
                    name: stateName,
                    fileHash: currentFileHash, // Reference to the local file
                    studentsData: simplifiedStudentsData,
                    questionsData: simplifiedQuestionsData,
                    comments: studentComments,
                    currentStudentIndex: currentStudentIndex,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    userId: currentUserId  // Using our consistent user ID instead of Firebase Auth
                };
                
                // Save the state to Firestore
                let stateRef;
                if (currentStateId) {
                    // Update existing state
                    stateRef = firestore.collection('states').doc(currentStateId);
                    await stateRef.update(stateData);
                } else {
                    // Create new state
                    stateRef = await firestore.collection('states').add(stateData);
                    currentStateId = stateRef.id;
                }
                
                // Update UI
                currentStateName = stateName;
                stateNameInput.value = '';
                
                // Hide loading indicator
                loadingIndicator.style.display = 'none';
                
                // Reload the states list
                loadSavedStates();
                
                alert('משימת ההערכה נשמרה בהצלחה');
            } catch (error) {
                console.error('Error saving state:', error);
                loadingIndicator.style.display = 'none';
                alert('שגיאה בשמירת משימת ההערכה: ' + error.message);
            }
        }
        
        // Load saved states from Firebase
        async function loadSavedStates() {
            if (!userInitialized) {
                console.log('User not initialized yet, will load states after initialization');
                return;
            }
            
            try {
                // Clear the list
                stateList.innerHTML = '';
                
                // Get states for the current user - simplified query that doesn't require a composite index
                const snapshot = await firestore.collection('states')
                    .where('userId', '==', currentUserId)
                    .get();
                
                if (snapshot.empty) {
                    console.log('No saved states found');
                    return;
                }
                
                // Get all states and manually sort them
                let states = [];
                snapshot.forEach(doc => {
                    states.push({
                        id: doc.id,
                        data: doc.data()
                    });
                });
                
                // Sort states by timestamp (newest first) after retrieving them
                states.sort((a, b) => {
                    const timeA = a.data.timestamp ? a.data.timestamp.toDate().getTime() : 0;
                    const timeB = b.data.timestamp ? b.data.timestamp.toDate().getTime() : 0;
                    return timeB - timeA;
                });
                
                // Add each state to the list
                states.forEach(state => {
                    const stateId = state.id;
                    const stateData = state.data;
                    
                    const li = document.createElement('li');
                    li.className = 'state-item';
                    if (currentStateId === stateId) {
                        li.classList.add('active');
                    }
                    
                    // Format date
                    const timestamp = stateData.timestamp ? stateData.timestamp.toDate() : new Date();
                    const formattedDate = `${timestamp.getDate()}/${timestamp.getMonth() + 1}/${timestamp.getFullYear()}`;
                    
                    li.innerHTML = `
                        <div class="state-name" title="${stateData.name}">${stateData.name}</div>
                        <small class="text-muted">${formattedDate}</small>
                        <div class="state-tools">
                            <button class="btn btn-sm btn-outline-danger delete-state" data-id="${stateId}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    // Add click event to load the state
                    li.addEventListener('click', (e) => {
                        // Don't load if delete button was clicked
                        if (e.target.closest('.delete-state')) return;
                        loadState(stateId);
                    });
                    
                    stateList.appendChild(li);
                });
                
                // Add delete event listeners
                document.querySelectorAll('.delete-state').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const stateId = btn.dataset.id;
                        deleteState(stateId);
                    });
                });
            } catch (error) {
                console.error('Error loading states:', error);
                alert('שגיאה בטעינת משימות ההערכה: ' + error.message);
            }
        }
        
        // Load a state
        async function loadState(stateId) {
            if (!userInitialized) {
                alert('אנא המתן לאתחול המערכת...');
                return;
            }
            
            // Show loading indicator
            loadingIndicator.style.display = 'block';
            
            try {
                // Get the state document from Firestore
                const stateDoc = await firestore.collection('states').doc(stateId).get();
                
                if (!stateDoc.exists) {
                    loadingIndicator.style.display = 'none';
                    alert('משימת ההערכה לא נמצאה');
                    return;
                }
                
                const state = stateDoc.data();
                
                // Try to get the file data from IndexedDB
                try {
                    const fileData = await localDB.get('files', state.fileHash);
                    
                    if (fileData && fileData.data) {
                        // We have the file locally
                        currentFileData = fileData.data;
                        
                        // Restore full state with file data
                        currentFileHash = state.fileHash;
                        studentsData = state.studentsData;
                        questionsData = state.questionsData;
                        studentComments = state.comments || {};
                        currentStudentIndex = state.currentStudentIndex || 0;
                        currentStateName = state.name;
                        currentStateId = stateId;
                        
                        // Update UI
                        populateStudentDropdown();
                        showStudentReport(currentStudentIndex);
                        stateNameInput.value = currentStateName;
                        navigationControls.style.display = 'block';
                        studentReport.style.display = 'block';
                        
                        // Update active state in list
                        updateActiveStateInList(stateId);
                        
                        // Hide loading indicator
                        loadingIndicator.style.display = 'none';
                    } else {
                        // We don't have the file locally - show recovery mode info
                        restoreStateWithoutFile(state, stateId);
                    }
                } catch (fileError) {
                    console.error('Error getting file from IndexedDB:', fileError);
                    // We don't have the file locally - show recovery mode
                    restoreStateWithoutFile(state, stateId);
                }
            } catch (error) {
                console.error('Error loading state:', error);
                loadingIndicator.style.display = 'none';
                alert('שגיאה בטעינת משימת ההערכה: ' + error.message);
            }
        }
        
        // Helper function to restore state without file data
        function restoreStateWithoutFile(state, stateId) {
            // We can still show reports without the Excel file
            currentFileHash = state.fileHash;
            studentsData = state.studentsData;
            questionsData = state.questionsData;
            studentComments = state.comments || {};
            currentStudentIndex = state.currentStudentIndex || 0;
            currentStateName = state.name;
            currentStateId = stateId;
            currentFileData = null;
            
            // Update UI
            populateStudentDropdown();
            showStudentReport(currentStudentIndex);
            stateNameInput.value = currentStateName;
            navigationControls.style.display = 'block';
            studentReport.style.display = 'block';
            updateActiveStateInList(stateId);
            
            // Hide loading indicator
            loadingIndicator.style.display = 'none';
            
            // Show recovery message
            alert('משימת ההערכה זו נוצרה במחשב אחר. הנתונים שוחזרו אך קובץ האקסל המקורי אינו זמין במכשיר זה. ניתן לראות את הדוחות אך יש לטעון מחדש את קובץ האקסל כדי לערוך שינויים.');
        }
        
        // Delete a state
        async function deleteState(stateId) {
            if (!userInitialized) {
                alert('אנא המתן לאתחול המערכת...');
                return;
            }
            
            if (!confirm('האם אתה בטוח שברצונך למחוק משימת הערכה זו?')) {
                return;
            }
            
            try {
                // Delete the state document from Firestore
                await firestore.collection('states').doc(stateId).delete();
                
                // If we're deleting the current state, reset the UI
                if (currentStateId === stateId) {
                    resetApp();
                }
                
                // Reload the states list
                loadSavedStates();
                
                alert('משימת ההערכה נמחקה בהצלחה');
            } catch (error) {
                console.error('Error deleting state:', error);
                alert('שגיאה במחיקת משימת ההערכה: ' + error.message);
            }
        }
        
        // Reset the app
        function resetApp() {
            studentsData = [];
            currentStudentIndex = 0;
            questionsData = {
                broadSubjects: {},
                subjects: {},
                maxScores: {}
            };
            studentComments = {};
            currentFileHash = '';
            currentStateName = 'משימת הערכה ללא שם';
            currentStateId = null;
            currentFileData = null;
            
            // Reset UI
            navigationControls.style.display = 'none';
            studentReport.style.display = 'none';
            fileInput.value = '';
        }

        // Helper function to update active state in the list
        function updateActiveStateInList(stateId) {
            const stateItems = document.querySelectorAll('.state-item');
            stateItems.forEach(item => {
                item.classList.remove('active');
                const deleteBtn = item.querySelector('.delete-state');
                if (deleteBtn && parseInt(deleteBtn.dataset.id) === stateId) {
                    item.classList.add('active');
                }
            });
            
            // Close sidebar on mobile
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        // Toggle sidebar
        function toggleSidebar() {
            stateSidebar.classList.toggle('open');
            mainContent.classList.toggle('sidebar-open');
        }

        // Event listeners for sidebar
        sidebarToggle.addEventListener('click', toggleSidebar);
        closeSidebarBtn.addEventListener('click', toggleSidebar);
        saveStateBtn.addEventListener('click', saveCurrentState);

        // Listen for file upload
        fileInput.addEventListener('change', handleFileUpload);
        studentSelect.addEventListener('change', handleStudentSelect);
        prevStudentBtn.addEventListener('click', showPreviousStudent);
        nextStudentBtn.addEventListener('click', showNextStudent);
        printReportBtn.addEventListener('click', printCurrentReport);
        commentsInput.addEventListener('input', saveCurrentComment);

        // Add event listeners for new buttons
        saveAsBtn.addEventListener('click', saveAsNewState);
        resaveBtn.addEventListener('click', updateCurrentState);
        newStateBtn.addEventListener('click', startNewState);

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            loadingIndicator.style.display = 'block';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    // Store the file data for saving states
                    currentFileData = data;
                    // Generate hash for this file
                    currentFileHash = generateSimpleHash(data);
                    // Reset state info for new file
                    currentStateId = null;
                    currentStateName = 'משימת הערכה ללא שם';
                    processExcelFile(data);
                } catch (error) {
                    alert('אירעה שגיאה בעיבוד הקובץ: ' + error.message);
                    loadingIndicator.style.display = 'none';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processExcelFile(data) {
            try {
                // Parse Excel file
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Find the correct sheet (using the 6th sheet or "מיפוי סוף שנה ")
                let sheetName = "מיפוי סוף שנה ";
                if (!workbook.Sheets[sheetName]) {
                    // Try to find the sheet that contains our data
                    for (const name of workbook.SheetNames) {
                        if (name.includes("מיפוי") && name.includes("שנה")) {
                            sheetName = name;
                            break;
                        }
                    }
                    // If still not found, use the first sheet
                    if (!workbook.Sheets[sheetName]) {
                        sheetName = workbook.SheetNames[0];
                    }
                }
                
                const sheet = workbook.Sheets[sheetName];
                const sheetData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });
                
                // Extract data from sheet
                extractDataFromSheet(sheetData);
                
                // Load saved comments from localStorage
                loadCommentsFromStorage();
                
                // Populate student dropdown
                populateStudentDropdown();
                
                // Show navigation controls
                navigationControls.style.display = 'block';
                
                // Show first student report
                showStudentReport(0);
                
                loadingIndicator.style.display = 'none';
                studentReport.style.display = 'block';
            } catch (error) {
                alert('אירעה שגיאה בעיבוד הקובץ: ' + error.message);
                console.error(error);
                loadingIndicator.style.display = 'none';
            }
        }

        function extractDataFromSheet(sheetData) {
            // Find important rows
            let broadSubjectsRow = -1;
            let subjectsRow = -1;
            let maxScoresRow = -1;
            let studentStartRow = -1;
            
            for (let i = 0; i < sheetData.length; i++) {
                const row = sheetData[i] || [];
                const rowString = row.join(' ');
                
                if (rowString.includes('נושא מתמטי')) {
                    broadSubjectsRow = i;
                } else if (rowString.includes('נושאי השאלות')) {
                    subjectsRow = i;
                } else if (rowString.includes('ניקוד לפריט >>')) {
                    maxScoresRow = i;
                    studentStartRow = i + 1;
                    break;
                }
            }
            
            if (broadSubjectsRow === -1 || subjectsRow === -1 || maxScoresRow === -1) {
                throw new Error('לא נמצאו כותרות חשובות בקובץ האקסל');
            }
            
            // Extract column indices for important data
            const studentNameColIdx = 1; // Column B
            const totalScoreColIdx = 6; // Column G
            const questionsStartColIdx = 8; // Column I
            
            // Extract question data
            const broadSubjects = sheetData[broadSubjectsRow] || [];
            const subjects = sheetData[subjectsRow] || [];
            const maxScores = sheetData[maxScoresRow] || [];
            
            // Create mappings for questions
            for (let i = questionsStartColIdx; i < subjects.length; i++) {
                if (subjects[i] && maxScores[i] && !isNaN(maxScores[i])) {
                    questionsData.subjects[i] = subjects[i];
                    questionsData.maxScores[i] = maxScores[i];
                    
                    // Link to broad subject
                    const broadSubject = broadSubjects[i] || 'אחר';
                    questionsData.broadSubjects[i] = broadSubject;
                    
                    // Initialize the broad subject group if it doesn't exist
                    if (!questionsData[broadSubject]) {
                        questionsData[broadSubject] = {};
                    }
                    
                    // Add the subject to its broad subject group
                    if (!questionsData[broadSubject][subjects[i]]) {
                        questionsData[broadSubject][subjects[i]] = [];
                    }
                    
                    questionsData[broadSubject][subjects[i]].push(i);
                }
            }
            
            // Extract student data
            for (let i = studentStartRow; i < sheetData.length; i++) {
                const row = sheetData[i];
                if (!row || !row[studentNameColIdx]) continue;
                
                const studentName = row[studentNameColIdx];
                if (typeof studentName !== 'string' || studentName.trim() === '' || studentName.includes('אחוזי הצלחה')) {
                    continue;
                }
                
                // Create student object
                const student = {
                    name: studentName,
                    totalScore: row[totalScoreColIdx],
                    scores: {}
                };
                
                // Extract scores for each question
                for (const colIdx in questionsData.subjects) {
                    if (row[colIdx] !== null && row[colIdx] !== undefined && !isNaN(row[colIdx])) {
                        student.scores[colIdx] = parseFloat(row[colIdx]);
                    } else {
                        student.scores[colIdx] = 0;
                    }
                }
                
                studentsData.push(student);
            }
            
            // Initialize empty comments for all students
            studentsData.forEach((student, index) => {
                studentComments[index] = '';
            });
        }

        function populateStudentDropdown() {
            studentSelect.innerHTML = '';
            studentsData.forEach((student, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = student.name;
                studentSelect.appendChild(option);
            });
        }

        function handleStudentSelect() {
            const selectedIndex = parseInt(studentSelect.value);
            showStudentReport(selectedIndex);
        }

        function showPreviousStudent() {
            saveCurrentComment();
            if (currentStudentIndex > 0) {
                showStudentReport(currentStudentIndex - 1);
            }
        }

        function showNextStudent() {
            saveCurrentComment();
            if (currentStudentIndex < studentsData.length - 1) {
                showStudentReport(currentStudentIndex + 1);
            }
        }

        function saveCurrentComment() {
            const commentText = commentsInput.value;
            studentComments[currentStudentIndex] = commentText;
            
            // Save to localStorage whenever a comment is updated
            saveCommentsToStorage();
        }

        function showStudentReport(studentIndex) {
            if (studentIndex < 0 || studentIndex >= studentsData.length) return;
            
            // Update current student index
            currentStudentIndex = studentIndex;
            studentSelect.value = studentIndex;
            
            // Get student data
            const student = studentsData[studentIndex];
            
            // Set report title
            reportTitle.textContent = `${student.name} - משוב למשימת הערכה סוף שנה`;
            
            // Clear table body
            reportTableBody.innerHTML = '';
            
            // Calculate subject mastery
            const subjectMastery = calculateSubjectMastery(student);
            
            // Populate report table
            const processedSubjects = new Set();
            
            // Create array to track visual row indices for each broad subject
            const broadSubjectRows = {};
            
            // Group by broad subject
            for (const broadSubject in questionsData) {
                if (broadSubject === 'broadSubjects' || broadSubject === 'subjects' || broadSubject === 'maxScores') {
                    continue;
                }
                
                const subjects = questionsData[broadSubject];
                if (!subjects || Object.keys(subjects).length === 0) continue;
                
                // Initialize row counter for this broad subject
                broadSubjectRows[broadSubject] = [];
                
                let isFirstInGroup = true;
                let rowCount = 0;
                
                // For each subject in this broad subject
                for (const subject in subjects) {
                    // Skip subjects we've already processed
                    if (processedSubjects.has(subject)) continue;
                    processedSubjects.add(subject);
                    
                    const questionIndices = subjects[subject];
                    if (!questionIndices || questionIndices.length === 0) continue;
                    
                    // Create row
                    const row = document.createElement('tr');
                    
                    // Store this row in the broadSubjectRows array
                    broadSubjectRows[broadSubject].push(row);
                    
                    // Add broad subject cell (only for first row in group)
                    const broadSubjectCell = document.createElement('td');
                    if (isFirstInGroup) {
                        broadSubjectCell.textContent = broadSubject;
                        broadSubjectCell.rowSpan = Object.keys(subjects).length;
                        broadSubjectCell.style.fontWeight = "700";
                        isFirstInGroup = false;
                    } else {
                        broadSubjectCell.style.display = 'none';
                    }
                    row.appendChild(broadSubjectCell);
                    
                    // Add subject cell
                    const subjectCell = document.createElement('td');
                    subjectCell.textContent = subject;
                    row.appendChild(subjectCell);
                    
                    // Add mastery cells
                    const goodMasteryCell = document.createElement('td');
                    const needsPracticeCell = document.createElement('td');
                    
                    goodMasteryCell.className = 'check-mark';
                    needsPracticeCell.className = 'check-mark';
                    
                    if (subjectMastery[subject] && subjectMastery[subject].masteryPercentage >= 50) {
                        goodMasteryCell.innerHTML = '<i class="fas fa-check-circle"></i>';
                    }
                    
                    if (subjectMastery[subject] && subjectMastery[subject].masteryPercentage < 50) {
                        needsPracticeCell.innerHTML = '<i class="fas fa-check-circle"></i>';
                    }
                    
                    row.appendChild(goodMasteryCell);
                    row.appendChild(needsPracticeCell);
                    
                    // Add row to table
                    reportTableBody.appendChild(row);
                    rowCount++;
                }
                
                // If no subjects were added for this broad subject, add a placeholder row
                if (rowCount === 0 && Object.keys(subjects).length > 0) {
                    const row = document.createElement('tr');
                    
                    // Store this row in the broadSubjectRows array
                    broadSubjectRows[broadSubject].push(row);
                    
                    // Add broad subject cell
                    const broadSubjectCell = document.createElement('td');
                    broadSubjectCell.textContent = broadSubject;
                    broadSubjectCell.style.fontWeight = "700";
                    row.appendChild(broadSubjectCell);
                    
                    // Add empty cells
                    for (let i = 0; i < 3; i++) {
                        const cell = document.createElement('td');
                        row.appendChild(cell);
                    }
                    
                    reportTableBody.appendChild(row);
                }
            }
            
            // Apply zebra striping to the entire table
            const allRows = reportTableBody.querySelectorAll('tr');
            allRows.forEach((row, index) => {
                if (index % 2 === 0) {
                    row.style.backgroundColor = '#fff';
                } else {
                    row.style.backgroundColor = 'rgba(0, 0, 0, 0.03)';
                }
            });
            
            // Set comments
            const comments = studentComments[studentIndex] || '';
            commentsInput.value = comments;
            reportComments.textContent = comments;
            
            // Update navigation buttons
            prevStudentBtn.disabled = studentIndex === 0;
            nextStudentBtn.disabled = studentIndex === studentsData.length - 1;
        }

        function calculateSubjectMastery(student) {
            const result = {};
            
            // Group questions by subject
            const subjectQuestions = {};
            
            for (const colIdx in questionsData.subjects) {
                const subject = questionsData.subjects[colIdx];
                if (!subjectQuestions[subject]) {
                    subjectQuestions[subject] = [];
                }
                subjectQuestions[subject].push(colIdx);
            }
            
            // Calculate mastery for each subject
            for (const subject in subjectQuestions) {
                const questionIndices = subjectQuestions[subject];
                let totalMaxScore = 0;
                let totalStudentScore = 0;
                
                questionIndices.forEach(idx => {
                    totalMaxScore += parseFloat(questionsData.maxScores[idx]) || 0;
                    totalStudentScore += parseFloat(student.scores[idx]) || 0;
                });
                
                // Calculate mastery percentage
                const masteryPercentage = totalMaxScore > 0 ? (totalStudentScore / totalMaxScore) * 100 : 0;
                
                result[subject] = {
                    totalMaxScore,
                    totalStudentScore,
                    masteryPercentage
                };
            }
            
            return result;
        }

        function printCurrentReport() {
            // Make sure comments are updated before printing
            saveCurrentComment();
            reportComments.textContent = studentComments[currentStudentIndex] || '';
            
            // Print the report
            window.print();
        }

        // Function to save as a new state (create a copy)
        async function saveAsNewState() {
            if (!currentFileData) {
                alert('אנא טען קובץ תחילה');
                return;
            }
            
            // Prompt for a new name with the current name as default
            const newName = prompt('הזן שם למשימת ההערכה החדשה:', currentStateName + ' - עותק');
            if (!newName) return; // User cancelled
            
            try {
                // Temporarily remove the current state ID to force a new save
                const previousStateId = currentStateId;
                currentStateId = null;
                stateNameInput.value = newName;
                
                // Call the save function
                await saveCurrentState();
                
                // Show success message
                alert('משימת ההערכה נשמרה בהצלחה כעותק חדש');
            } catch (error) {
                console.error('Error saving new state:', error);
                alert('שגיאה בשמירת משימת ההערכה החדשה: ' + error.message);
            }
        }
        
        // Function to update the current state
        async function updateCurrentState() {
            if (!currentStateId) {
                alert('אין משימת הערכה נוכחית לעדכון. אנא שמור משימת הערכה חדשה תחילה.');
                return;
            }
            
            try {
                // Set the input to the current name
                stateNameInput.value = currentStateName;
                
                // Call the save function
                await saveCurrentState();
                
                // Show success message
                alert('משימת ההערכה עודכנה בהצלחה');
            } catch (error) {
                console.error('Error updating state:', error);
                alert('שגיאה בעדכון משימת ההערכה: ' + error.message);
            }
        }
        
        // Function to start a new state
        function startNewState() {
            if (!confirm('האם אתה בטוח שברצונך להתחיל משימת הערכה חדשה? כל השינויים שלא נשמרו יאבדו.')) {
                return;
            }
            
            // Reset the app state
            resetApp();
            
            // Clear the file input to allow selecting a new file
            fileInput.value = '';
            
            // Update the UI
            alert('משימת הערכה חדשה התחילה. אנא טען קובץ חדש.');
            
            // Close the sidebar on mobile
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        // Generate a simple hash from file data for identification
        function generateSimpleHash(data) {
            let hash = 0;
            const sample = data.slice(0, 1000); // Use first 1000 bytes as a sample
            for (let i = 0; i < sample.length; i++) {
                hash = ((hash << 5) - hash) + sample[i];
                hash = hash & hash; // Convert to 32bit integer
            }
            return hash.toString(16);
        }

        // Get storage key for comments
        function getCommentsStorageKey() {
            return `studentReport_comments_${currentFileHash}`;
        }

        // Load comments from localStorage
        function loadCommentsFromStorage() {
            const storageKey = getCommentsStorageKey();
            const savedComments = localStorage.getItem(storageKey);
            if (savedComments) {
                try {
                    const parsedComments = JSON.parse(savedComments);
                    // Merge with current comments, preserving any new ones
                    for (const studentIndex in parsedComments) {
                        if (studentIndex < studentsData.length) {
                            studentComments[studentIndex] = parsedComments[studentIndex];
                        }
                    }
                    console.log(`Loaded comments from storage for ${Object.keys(parsedComments).length} students`);
                } catch (error) {
                    console.error('Error parsing comments from storage:', error);
                }
            }
        }

        // Save all comments to localStorage
        function saveCommentsToStorage() {
            const storageKey = getCommentsStorageKey();
            localStorage.setItem(storageKey, JSON.stringify(studentComments));
        }
    </script>
</body>
</html> 
</html> 